# Exhaustive tests for withMutations: primitives, objects, arrays, nested,
# dot-notation and array-index overrides from variations, variableOverrides, and rules.
feature: withMutations
assertions:
  # ========== Variation-only (everyone rule, no segment) ==========
  - at: 25
    environment: staging
    expectedToBeEnabled: true
    expectedVariation: control
    expectedVariables:
      title: "Control Title"
      count: 10
      score: 2.5
      enabled: true
      config:
        theme: dark
        compact: true
        width: 1200
      settings:
        display:
          fontSize: 16
          theme: light
        layout:
          sidebar: true
          width: 240
      deep:
        level1:
          level2:
            level3:
              value: "control-mutated"
              count: 1
      tags:
        - control
        - a
      items:
        - id: "1"
          name: "Control First"
          meta: { score: 0.99 }
        - id: "2"
          name: "Second"
          meta: { score: 0.2 }
        - id: "3"
          name: "Third"
          meta: { score: 0.3 }
      payload:
        name: "Control Payload"
        rows:
          - id: 1
            label: "Control A"
          - id: 2
            label: "B"
      mixed:
        name: "control-mixed"
        config:
          enabled: false
          tags:
            - x
            - y

  - at: 75
    environment: staging
    expectedToBeEnabled: true
    expectedVariation: treatment
    expectedVariables:
      title: "Treatment Title"
      count: 20
      score: 4.0
      enabled: false
      config:
        theme: dark
        compact: false
        width: 1600
      settings:
        display:
          fontSize: 16
          theme: dark
        layout:
          sidebar: false
          width: 320
      deep:
        level1:
          level2:
            level3:
              value: "treatment-deep"
              count: 2
      tags:
        - treatment
        - b
        - c
      items:
        - id: "1"
          name: "Treatment First"
          meta: { score: 0.5 }
        - id: "2"
          name: "Treatment Second"
          meta: { score: 0.6 }
        - id: "3"
          name: "Third"
          meta: { score: 0.3 }
      payload:
        name: "Treatment Payload"
        rows:
          - id: 1
            label: "Treatment A"
          - id: 2
            label: "Treatment B"
      mixed:
        name: "treatment-mixed"
        config:
          enabled: false
          tags:
            - t1
            - t2

  # ========== Rule override: Germany (staging) ==========
  - at: 50
    environment: staging
    context:
      country: de
    expectedToBeEnabled: true
    expectedVariables:
      title: "Germany (Staging)"
      count: 100
      score: 5.0
      enabled: true
      config:
        theme: dark
        compact: true
        width: 1400
      settings:
        display:
          fontSize: 18
          theme: dark
        layout:
          sidebar: true
          width: 260
      deep:
        level1:
          level2:
            level3:
              value: "germany-deep"
              count: 10
      tags:
        - de
        - germany
      items:
        - id: "1"
          name: "Erste"
          meta: { score: 1.0 }
        - id: "2"
          name: "Zweite"
          meta: { score: 1.0 }
        - id: "3"
          name: "Dritte"
          meta: { score: 1.0 }
      payload:
        name: "DE Payload"
        rows:
          - id: 1
            label: "DE-A"
          - id: 2
            label: "DE-B"
      mixed:
        name: "germany-mixed"
        config:
          enabled: true
          tags:
            - de
            - tag

  # ========== Rule override: NL or CH (staging) - rule variables + :prepend/:append/:before/:after/:remove ==========
  - at: 50
    environment: staging
    context:
      country: nl
    expectedToBeEnabled: true
    expectedVariables:
      title: "NL/CH Title"
      count: 50
      score: 3.5
      config:
        theme: light
        width: 1500
      settings:
        display:
          fontSize: 14
          theme: light
        layout:
          sidebar: false
          width: 240
      tags:
        - first
        - nl-ch
        - demo
        - extra
      items:
        - id: "1"
          name: "First"
          meta: { score: 0.1 }
        - id: "2a"
          name: "Before Second"
          meta: { score: 0.15 }
        - id: "2"
          name: "NL Second"
          meta: { score: 0.2 }
        - id: "2b"
          name: "After Second"
          meta: { score: 0.25 }
        - id: "3"
          name: "Third"
          meta: { score: 0.3 }
      payload:
        name: "NL/CH Payload"
        rows:
          - id: 1
            label: "A"
          - id: 2
            label: "B"
          - id: 3
            label: "C"

  - at: 50
    environment: staging
    context:
      country: ch
    expectedToBeEnabled: true
    expectedVariables:
      title: "NL/CH Title"
      count: 50
      score: 3.5
      config:
        theme: light
        width: 1500

  # ========== Rule override: Mobile EU (staging) - rule variables + items[2]:remove ==========
  - at: 50
    environment: staging
    context:
      device: mobile
      continent: europe
      country: fr
    expectedToBeEnabled: true
    expectedVariables:
      title: "Mobile EU"
      count: 1
      enabled: false
      config:
        theme: light
        compact: true
        width: 1200
      settings:
        display:
          fontSize: 14
          theme: dark
        layout:
          sidebar: true
          width: 240
      deep:
        level1:
          level2:
            level3:
              value: "mobile-eu"
              count: 1
      items:
        - id: "1"
          name: "First"
          meta: { score: 0.9 }
        - id: "2"
          name: "Second"
          meta: { score: 0.2 }
      mixed:
        name: "mobile-mixed"
        config:
          enabled: true
          tags:
            - x
            - y

  # ========== Same Germany rule when bucketed to treatment (at 75) ==========
  - at: 75
    environment: staging
    context:
      country: de
    expectedToBeEnabled: true
    expectedVariation: treatment
    expectedVariables:
      title: "Germany (Staging)"
      count: 100
      score: 5.0
      enabled: true
      config:
        theme: dark
        compact: true
        width: 1400
      tags:
        - de
        - germany
      items:
        - id: "1"
          name: "Erste"
          meta: { score: 1.0 }
        - id: "2"
          name: "Zweite"
          meta: { score: 1.0 }
        - id: "3"
          name: "Dritte"
          meta: { score: 1.0 }

  # ========== Same NL/CH rule when bucketed to treatment (at 75) ==========
  - at: 75
    environment: staging
    context:
      country: nl
    expectedToBeEnabled: true
    expectedVariation: treatment
    expectedVariables:
      title: "NL/CH Title"
      count: 50
      score: 3.5
      config:
        theme: light
        width: 1500
      tags:
        - first
        - nl-ch
        - demo
        - extra

  # ========== Production: Germany rule (subset overrides) ==========
  - at: 50
    environment: production
    context:
      country: de
    expectedToBeEnabled: true
    expectedVariables:
      title: "Germany (Production)"
      count: 200
      config:
        theme: dark
        compact: true
        width: 1200
      settings:
        display:
          fontSize: 20
          theme: light
        layout:
          sidebar: true
          width: 240
      items:
        - id: "1"
          name: "Erste Prod"
          meta: { score: 0.1 }
        - id: "2"
          name: "Second"
          meta: { score: 0.2 }
        - id: "3"
          name: "Third"
          meta: { score: 0.3 }
      payload:
        name: "Payload"
        rows:
          - id: 1
            label: "DE-Prod-A"
          - id: 2
            label: "B"

  # ========== Production: NL/CH rule (full replacement for tags) ==========
  - at: 50
    environment: production
    context:
      country: nl
    expectedToBeEnabled: true
    expectedVariables:
      title: "NL/CH (Production)"
      config:
        theme: light
        compact: true
        width: 2000
      tags:
        - prod
        - nl-ch

  # ========== Production: control variation (no segment) ==========
  - at: 25
    environment: production
    expectedToBeEnabled: true
    expectedVariation: control
    expectedVariables:
      title: "Control Title"
      count: 10
      config:
        theme: dark
        compact: true
        width: 1200
      deep:
        level1:
          level2:
            level3:
              value: "control-mutated"
              count: 1

  # ========== Production: treatment variation (no segment) ==========
  - at: 75
    environment: production
    expectedToBeEnabled: true
    expectedVariation: treatment
    expectedVariables:
      title: "Treatment Title"
      count: 20
      enabled: false
      items:
        - id: "1"
          name: "Treatment First"
          meta: { score: 0.5 }
        - id: "2"
          name: "Treatment Second"
          meta: { score: 0.6 }
        - id: "3"
          name: "Third"
          meta: { score: 0.3 }

  # ========== Partial assertions (subset of variables) ==========
  - at: 10
    environment: staging
    expectedToBeEnabled: true
    expectedVariation: control
    expectedVariables:
      title: "Control Title"
      count: 10
      enabled: true
      tags:
        - control
        - a

  - at: 90
    environment: staging
    expectedToBeEnabled: true
    expectedVariation: treatment
    expectedVariables:
      title: "Treatment Title"
      enabled: false
      score: 4.0

  - at: 50
    environment: staging
    context:
      country: us
    expectedToBeEnabled: true
    expectedVariables:
      title: "Control Title"
      count: 10

  - at: 75
    environment: staging
    context:
      country: us
    expectedToBeEnabled: true
    expectedVariation: treatment
    expectedVariables:
      title: "Treatment Title"
      count: 20
      enabled: false

  # ========== Edge: desktop EU does not match mobile_eu, gets everyone -> variation vars ==========
  - at: 75
    environment: staging
    context:
      device: desktop
      continent: europe
      country: it
    expectedToBeEnabled: true
    expectedVariation: treatment
    expectedVariables:
      title: "Treatment Title"
      config:
        theme: dark
        compact: false
        width: 1600

  # ========== Switzerland: matches nl_or_ch rule (same as NL) ==========
  - at: 25
    environment: staging
    context:
      country: ch
    expectedToBeEnabled: true
    expectedVariation: control
    expectedVariables:
      title: "NL/CH Title"
      count: 50
      score: 3.5
      config:
        theme: light
        width: 1500
